<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <style>
        .canvas {
            width: 100%;
            height: 400px;
        }
    </style>
</head>
<body>
    <div id='log'></div>
    <div class='canvas'>
        <canvas id="render" width="1000" height="400"></canvas>
    </div>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js'></script>
    <script type="module">
        
        try {
        const ledger = {"name":"Vendas 1º médio","members":{},"history":[{"id":"b-AtZnCSO5bc9U8dN-cTW","subject":"Enzo","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"_X1p8aXViZ9jb9n46RjuB","subject":"João Lucas","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"2eTEhjTzVYVg0ydwwQCZM","subject":"João Pedro","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"Z8pGpZdvtDAk5W0sRzzha","subject":"Rian","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"_kkxDkgEstAwsaUSqQczv","subject":"Brandão","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"q29e1HjrWAcDp2O53jJWw","subject":"Otto","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"KhO63DEKW3sQ1s87KQ94u","subject":"Julia","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"EX20n_G1DJWDMZ3eB9xCX","subject":"Luísa","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"7xizkuRg-gloE7HQ7vmwA","subject":"Igor","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"UAjewFav34KkN3lVTFzR3","subject":"Miguel","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"Oz-AL2WU2uNfnNXuqfKDS","subject":"Eduardo","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the initial investment"},{"id":"xKIA3kRZ2aDTVFgb77Gtx","subject":"Doações","operation":"donation","target":"Caixa","amount":110,"note":"Doações collected its first investment and now is gonna use it to buy ingredients for the production"},{"id":"qw4A25dsqiM6zNO9xXLDB","subject":"João Pedro","operation":"donation","target":"Caixa","amount":6,"note":"Donated R$ 6,00 out of his kindness"},{"id":"HZ76ugzYcVamGZoT_7E0L","subject":"Caixa","operation":"payment","target":"Supermercado São Luís","amount":113.34999999999998,"note":{"id":"pFipF6wrYPkKUVuJuhQDJ","name":"Ingredients","total":113.34999999999998,"tax":0,"items":[{"name":"Leite Ninho (380g)","price":17.99,"amount":1},{"name":"Leite Condensado (295g)","price":7.49,"amount":3},{"name":"Creme de Leite (300g)","price":7.99,"amount":4},{"name":"Leite (1L)","price":4.99,"amount":5},{"name":"Liga Neutra (100g)","price":5.99,"amount":1},{"name":"Granulado (750g)","price":9.99,"amount":1}]}},{"id":"EZcwgOWH4L4r1FO66s1BC","subject":"Luísa","operation":"lent","target":"Caixa","amount":60,"note":"Luísa lent the money to buy fruit juice"},{"id":"UkWaKyHB4zZqUdl_256Ov","subject":"Caixa","operation":"payment","target":"Serv Festas","amount":60,"note":{"id":"j-D3_3dha-Yau1zuJdeGb","name":"Fruit Juice","total":60,"tax":0,"items":[{"name":"Suco de Morango (2L)","price":15,"amount":3},{"name":"Groselha","price":7.5,"amount":2}]}},{"id":"3dohMNlEtjIPMZJcFw3L9","subject":"João Lucas","operation":"lent","target":"Caixa","amount":20,"note":"The ingredients bought weren't enough. Enzo is going to the supermaket to buy more"},{"id":"IWoyt6IxnGY_BJLvy09lL","subject":"Enzo","operation":"lent","target":"Caixa","amount":13,"note":"Helping with more ingredients"},{"id":"vnzk9S7pEZkoFGNxKx8cq","subject":"Caixa","operation":"payment","target":"Supermercado São Luís","amount":30.450000000000003,"note":{"id":"CXkAZGoY6TxoCBcrog9FL","name":"Buying more ingredients","total":30.450000000000003,"tax":0,"items":[{"name":"Leite Condensado (295g)","price":7.49,"amount":1},{"name":"Creme de Leite (300g)","price":7.99,"amount":1},{"name":"Leite (1L)","price":4.99,"amount":3}]}},{"id":"p5bCJHeRqQMlXr_fqmsoC","subject":"Caixa","operation":"receipt","target":"Juju","amount":518,"note":{"id":"hKjkyWwMcTEFyvd0WOHqS","name":"Vendas de Juju","total":518,"tax":0,"items":[{"name":"Chocolate","price":3,"amount":70},{"name":"Leite Ninho","price":3,"amount":26},{"name":"Groselha","price":2,"amount":37},{"name":"Morango","price":2,"amount":78}]}},{"id":"9FcHw1O4X2sLOumWeYdb2","subject":"Caixa","operation":"payment","target":"João Lucas","amount":20,"note":"Money lending of R$20"},{"id":"0BBWRmoanffLGKSGKq3wX","subject":"Caixa","operation":"payment","target":"Enzo","amount":10,"note":"Money lending of R$13"},{"id":"PVTM99FeQWCcONuSz-FUH","subject":"Caixa","operation":"payment","target":"Luísa","amount":60,"note":"Money lending of R$60"},{"id":"_6C0frpDysj6u2wP8BVzR","subject":"João Lucas","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"sAACrYnX1NNdgPjRZ7wXm","subject":"Enzo","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"xhzAKNsGAe6TAbgOxBy0Z","subject":"Julia","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"fX6soQgH3HpuRt5Ad6AU-","subject":"Eduardo","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"81ryDSExm3uKCvu1Ohr5g","subject":"Luísa","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"JylrFQAMg0Jfowwphfs9S","subject":"Rian","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"x6Kh2qh0YBYMX057Ks1ky","subject":"Otto","operation":"donation","target":"Doações","amount":10,"note":"Everyone donates R$ 10,00 to the second investment"},{"id":"M9OHs1liNFLxiLr92ZLp-","subject":"Doações","operation":"donation","target":"Caixa","amount":70,"note":"Everyone should have donated R$ 10,00 for the second investment, but some of them didn't. They include: João Pedro, Igor, Otto, Miguel, e Brandão"},{"id":"EZOT7u5ALIHwaDkcNxKqr","subject":"João Lucas","operation":"lent","target":"Caixa","amount":57,"note":"Buying cash register. Payment Date: 18/03"},{"id":"KYUhIX0FA62acMo-igwwu","subject":"Caixa","operation":"payment","target":"Mercado Livre","amount":57,"note":{"id":"SOcwmDjInfQa1b6spUCOa","name":"Purchase of the cash register","total":57,"tax":0,"items":[{"name":"Caixa Registradora","price":57,"amount":1}]}},{"id":"SYDWGbjRyrUfJze89Wk-W","subject":"Julia","operation":"lent","target":"Caixa","amount":69,"note":"Banners and A4 Plastifications. Payment Date 18:03"},{"id":"F12ip427AjSvvqdYwejsr","subject":"Caixa","operation":"payment","target":"Papelaria Criativa","amount":69,"note":{"id":"78YViI68YLUQBcrMv-qMd","name":"Impressions and Plastifications","total":69,"tax":0,"items":[{"name":"Impressão A3 Colorida","price":2.5,"amount":6},{"name":"Impressão A4 Colorida","price":1,"amount":15},{"name":"Plastificação A3","price":6,"amount":6},{"name":"Plastificação A4","price":3,"amount":1}]}},{"id":"EbiJ6PR2Od9-7aLb6Yspf","subject":"Enzo","operation":"lent","target":"Caixa","amount":224.5,"note":"The money needed to buy the pizzas"},{"id":"vRWg2_4USp70UJ8aAOmpi","subject":"Caixa","operation":"payment","target":"Pizzaria Specialle","amount":700,"note":{"id":"WBlxU4YfHGibRAaZrXfg3","name":"Purchase of the products","total":700,"tax":0,"items":[{"name":"Presunto e Queijo","price":2,"amount":350}]}},{"id":"w0kuFanMcvWus2AzVLQ8j","subject":"Enzo","operation":"lent","target":"Caixa","amount":50,"note":"Purchase of nakpins and change. Payment Date"},{"id":"VYRgUx880MNVkmeRa-nMY","subject":"Caixa","operation":"payment","target":"Papelaria Central","amount":16.299999999999997,"note":{"id":"-n7_5ILrp4hFGMGUbk08n","name":"Purchase of of extra material","total":16.299999999999997,"tax":0,"items":[{"name":"Tesoura","price":4.5,"amount":1},{"name":"Fita Adesiva","price":8.6,"amount":1},{"name":"Lápis","price":1.7,"amount":1},{"name":"Bloquinho de Notas","price":1.5,"amount":1}]}},{"id":"2MH4sx20Pwea47vTE0E89","subject":"Caixa","operation":"payment","target":"Supermercado São Luís","amount":35.910000000000004,"note":{"id":"loQENO6AHO_DzNieDVfnL","name":"Purchase of napkins","total":35.910000000000004,"tax":0,"items":[{"name":"Guardanapos","price":3.99,"amount":9}]}},{"id":"b9X3n3_Kq4_7OAju4ljEl","subject":"Luísa","operation":"lent","target":"Caixa","amount":50,"note":"Lending the money for those purchases"},{"id":"boI6Yk8DjO9UyiHNs4iej","subject":"Caixa","operation":"payment","target":"Enzo","amount":50,"note":"He couldn't pay for everything as he had already lent the money for the purchase of the pizzas"},{"id":"Kko62rEY7KdLbzWSfMykp","subject":"Enzo","operation":"donation","target":"Caixa","amount":13.55,"note":"Donating coins for extra change as we are gonna need for the sales on march 14th"}]};
        const focus = 'Caixa';
        
        function fetch(items) {
    
            var some  = props => items.filter(entry => Object.entries(props).some (([key, filter]) => entry[key] === filter(entry)))
            var every = props => items.filter(entry => Object.entries(props).every(([key, filter]) => entry[key] === filter(entry)))

            return {
                some,
                every
            }
        };

        const items = fetch(ledger.history).some({
            subject: () => focus,
            target: () => focus
        });

        let balance = 0;
        const config = {
            type: 'line',
            data: {
                labels: items.map((item, index) => index + 1),
                datasets: [{
                    label: 'Balance',
                    data: [0,...items.map(item => {

                        switch(item.operation) {
                            case 'donation': focus == item.subject? balance -= item.amount : balance += item.amount; break;
                            case 'receipt' : focus == item.subject? balance += item.amount : balance -= item.amount; break;
                            case 'payment' : focus == item.subject? balance -= item.amount : balance += item.amount; break;
                            case 'lent' :    focus == item.subject? balance -= item.amount : balance += item.amount;  break;
                            default: 0;
                        };

                        return balance;
                    }) ],
                    fill: true,
                    borderColor: 'rgb(75, 192, 192)',
                    cubicInterpolationMode: 'monotone',
                    backgroundColor: items.map(({ subject, target, operation }) => {
    
                        var color;
                        var grey = '#707070'
                        var red = '#E86565'
                        var green = '#00C67E';

                        subject == focus? 

                        operation == 'receipt'?

                            color = green :
                            color = red :

                        target == focus? 
    
                        operation == 'receipt' ?

                            color = red:
                            color = green :

                        color = grey;

                        return color;
                    }),
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
        };

        const logger = document.querySelector('#log');
        const canvas = document.querySelector('#render');
        const context = canvas.getContext('2d');

        context.fillStyle = 'black';
        context.fillRect(0, 0, 100, 100);

        new Chart(context, config);
    } catch(e) {
        alert(e);
    }
    </script>
</body>
</html>